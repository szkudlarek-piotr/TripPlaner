<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="container">
        <div id="autocomplete">
            <input type="text" id="countriesInput" onkeyup="showSuggestions()" />
        </div>
    </div>
    <script>
        

        function displayData(countryDivs) {
            let suggestionsDiv = document.getElementById("allCountriesSuggestions")
            for (let i=0; i<countryDivs.length; i++) {
                let checked_country = countryDivs[i]
                console.log(checked_country)
                suggestionsDiv.appendChild(checked_country)
            }
        }

        function showSuggestions() {
            let autocompleteDiv = document.getElementById("autocomplete")
            let inputValue = document.getElementById("countriesInput")
            if (autocompleteDiv.childElementCount === 1) {
                let suggestionsDiv = document.createElement("div")
                suggestionsDiv.setAttribute("class", "autocomplete-items")
                suggestionsDiv.setAttribute("id", "allCountriesSuggestions")
            }

            getCountriesDivs(displayData) 
        }

        function getCountriesDivs(callback) {
            // let allCountriesDivs = document.createElement("div")
            // allCountriesDivs.setAttribute("class", "autocomplete-items")
            // allCountriesDivs.innerHTML = ""
            const input_txt = document.getElementById('countriesInput').value

            if (input_txt.length > 1) {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", "http://localhost:3000/countries?search=" + input_txt)
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        const status = xhr.status;
                        const countriesToShow = JSON.parse(xhr.responseText)
                        const countriesDivs = countriesToShow.map(function(country){
                            let countryName = country.name
                            let countryFlag = country.flag
                            let boldedName = boldCountryName(input_txt, countryName)
                            let countryDiv =`<div class="country_div" value="${countryName}">
                                                <div class="country_name">${boldedName}</div>
                                                <div class="flag"><img src="flags/${countryFlag}" alt="flag of ${countryName}"></div>
                                            </div>`
                            return countryDiv
                        })
                        console.log('data got', countriesDivs)
                       
                        callback(countriesDivs)
                    }
                };

            xhr.send(input_txt);
        }}

        function boldCountryName(inputText, countryName) {
            let capitalizedInput = inputText.toUpperCase()
            let capitalizedCountryName = countryName.toUpperCase()
            const boldStartIndex = capitalizedCountryName.indexOf(capitalizedInput)
            const boldStopIndex = boldStartIndex + inputText.length
            const beforeText = countryName.substring(0, boldStartIndex)
            const boldedText = countryName.substring(boldStartIndex, boldStopIndex)
            const afterText = countryName.substring(boldStopIndex)
            const boldedCountry = `${beforeText}<b>${boldedText}</b>${afterText}`
            return boldedCountry
        }
    </script>
</body>

</html>