<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="container">
        <div id="autocomplete">
            <input type="text" id="countriesInput" onkeyup="showSuggestions()" />
        </div>
    </div>
    <script>
        function clearCountryDivs() {
            let autocompleteDiv = document.getElementById("autocomplete")
            let childrenArr = autocompleteDiv.children
            while (autocompleteDiv.childElementCount > 1) {
                autocompleteDiv.lastChild.remove()
            }
            
        } 

        function displayData(countryDivs) {
            clearCountryDivs()
            let autocompleteDiv = document.getElementById("autocomplete")

            console.log(countryDivs)
            let numberOfCountries = countryDivs.length
            for (let i = 0; i < numberOfCountries; i++) {
                let processedCountry = countryDivs[i]
                let innerContent = processedCountry.inner_text
                let code = processedCountry.code
                let createdDiv = document.createElement("div")
                createdDiv.setAttribute("class", "country_div")
                createdDiv.setAttribute("id", code)
                createdDiv.innerHTML = innerContent
                autocompleteDiv.appendChild(createdDiv)
            }
            
        }

        function showSuggestions() {
            let autocompleteDiv = document.getElementById("autocomplete")
            let inputValue = document.getElementById("countriesInput")
            if (autocompleteDiv.childElementCount === 1) {
                let suggestionsDiv = document.createElement("div")
                suggestionsDiv.setAttribute("class", "autocomplete-items")
                suggestionsDiv.setAttribute("id", "allCountriesSuggestions")
            }

            getCountriesDivs(displayData) 
        }

        function getCountriesDivs(callback) {

            const input_txt = document.getElementById('countriesInput').value

            if (input_txt.length > 1) {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", "http://localhost:3000/countries?search=" + input_txt)
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        const status = xhr.status;
                        const countriesToShow = JSON.parse(xhr.responseText)
                        const countriesDivs = countriesToShow.map(function(country){
                            let countryName = country.name
                            let countryFlag = country.flag
                            let boldedName = boldCountryName(input_txt, countryName)
                            let countryJSON ={inner_text: `<div class="country_name">
                                                ${boldedName}</div>
                                            <div class="flag"><img src="flags/${countryFlag}" alt="flag of ${countryName}"></div>`,
                                            code: countryName}
                            return countryJSON
                        })
                        console.log('data got', countriesDivs)
                        countriesDivsStringified = JSON.stringify(countriesDivs)
                        callback(countriesDivs)
                    }
                };

            xhr.send(input_txt);
        }}

        function boldCountryName(inputText, countryName) {
            let capitalizedInput = inputText.toUpperCase()
            let capitalizedCountryName = countryName.toUpperCase()
            const boldStartIndex = capitalizedCountryName.indexOf(capitalizedInput)
            const boldStopIndex = boldStartIndex + inputText.length
            const beforeText = countryName.substring(0, boldStartIndex)
            const boldedText = countryName.substring(boldStartIndex, boldStopIndex)
            const afterText = countryName.substring(boldStopIndex)
            const boldedCountry = `${beforeText}<b>${boldedText}</b>${afterText}`
            return boldedCountry
        }
    </script>
</body>

</html>